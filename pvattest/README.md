# pvattest

`pvattest` is a tool to attest an IBM Secure Execution guest running on on z16 and later.
With `pvattest` one can create attestation requests in a trusted environment and attest
an IBM Secure Execution guest to verify that a secure configuration is the correct one
and was actually started in a secure manner.
To achieve this, there exists 3 commands:
  * `create` creates such request in a trusted environment.
  * `measure` sends the attestation request to the Ultravisor and receive the answer (works z16 SE guest only).
  * `verify` checks if the answer from the Ultravisor is the one you expect. If they differ, the Secure Execution guest might not be the one you think it is or the guest is not secure at all.

In order to get credible results, 'create' and 'verify' must be run in a trusted environment,
like your workstation or a previously attested IBM Secure Execution guest.
Otherwise, the attestation might be tampered.
For all certificates, revocation lists, and host-key documents, both the PEM and DER input
formats are supported. If you run this program on a non S390 System, 'measure' is not be available.

## Getting started

If all dependencies are met a simple `make` call in the source tree
should be enough for building `pvattest`.

## Details
### create
`pvattest create` needs the Host key document, a location to store the
attestation request protection key, and a location to store the request data.
If the `--no-verify` flag is not set it additionally requires the IBM signing key
and the intermediate CA. The output will be the request in binary form to feed into `pvattest measure`
Must be run in a trusted environment. Especially, do not create the request on a system you want to attest.
Ensure, to keep the attestation request protection key until verification is done.
This key will only be valid for this request, and should be discarded after verification.
Keep this key secret.

## measure
`pvattest measure` needs an request in binary form and a location to store the output.
It will send the request to the device in`/dev/uv` which passes the request to the Ultravisor.
Kernel must provide the ultravisor user interface.
The output includes the original request and the answer from the Ultravisor.

## verify
`pvattest verify` needs the SE-guest header, the attestation request protection key,
and the attestation request + ultravisor answer from `pvattest measure` as input.
It calculates the measurement on its own and compares it to the measurement done
by the Ultravisor in the previous step. If they differ exit code 2 is emitted,
if an internal error happens (e.g. header is invalid) 1 is emitted, otherwise 0.
Must be run in a trusted environment. Especially, do not verify on the system you want to attest.

## Measurement
The measurement is a cryptographic measurement of the following block.
Currently HMAC-SHA512 is the only supported function.

| Start   | Size       | Content                                                       |
|---------|------------|---------------------------------------------------------------|
| 0x0     | 0x40       | Page List Digest (from SE header)                             |
| 0x40    | 0x40       | Address List Digest (from SE header)                          |
| 0x80    | 0x40       | Tweak List Digest (from SE header)                            |
| 0xc0    | 0x10       | SE HEader Tag (from SE header)                                |
| 0xd0    | 0x10       | Configuration Uid (generated by UV, included in the answer)   |
| 0xe0    | 0x02       | User Data Length (defined during measurement on the SE-guest) |
| 0xe2    | 0x02       | Zeros                                                         |
| 0xe4    | 0x04       | Additional Data Length (set by uv, included in the answer)    |
| 0xe8    | 0 - 0x100  | User Data (generated during measurement on the SE-guest)      |
| ...     | 0 or 0x10  | Optional Nonce (generated during request creation)            |
| ...     | 0 - 0x8000 | Additional Data (generated by uv, included in the answer)     |

### User Data
The generation of user data is currently not supported by `pvattest`, therefore the length will always be Zero.
User Data is data generated by the SE guest and passed to UV during the measurement.
The User data must be known to or be replicable by the verifier to
verify the correctness of the User Data. For example User data can be a hash of `/boot` .

### Additional Data
Additonal data is data known to the Ultravisor. By default UV will not include any Additional Data.
The flags `--phkh-img` and `--phkh-att` will trigger the UV to include the public host key hash
corresponding to the private key used to unseal the SE header/ attestation request in the Additional Data.

## Examples

Create an Attestation Measurement Request in a trusted environment:

`pvattest create -k hkd.crt --arpk arp.key -o arcb.bin --cert IntermediateCA.crt --cert IbmSigningKey.crt`

Do an attestation measurement on an z16+ IBM Secure Execution guest:

`pvattest measure --input arcb.bin --output measurement.bin`

Verify the answer from the Attestation Measurement Request in a trusted environment:

`pvattest verify --input measurement.bin --arpk arp.key --hdr se_guest.hdr`
